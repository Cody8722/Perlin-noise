<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker è¼‰å…¥æ¸¬è©¦</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 2px solid;
        }
        .success {
            background: #1a4d1a;
            border-color: #00ff88;
            color: #00ff88;
        }
        .error {
            background: #4d1a1a;
            border-color: #ff4444;
            color: #ff4444;
        }
        .info {
            background: #1a1a4d;
            border-color: #00d4ff;
            color: #00d4ff;
        }
        pre {
            background: #0a0a0a;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        button {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00ff88;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Worker è¼‰å…¥è¨ºæ–·å·¥å…·</h1>

    <div class="status info">
        <strong>æ¸¬è©¦ç›®çš„ï¼š</strong>è¨ºæ–· terrain.worker.js æ˜¯å¦èƒ½æ­£å¸¸è¼‰å…¥
    </div>

    <div id="results"></div>

    <h2>æ¸¬è©¦æ“ä½œï¼š</h2>
    <button onclick="testSimpleWorker()">ğŸ”¹ æ¸¬è©¦ 1: ç°¡å–® Workerï¼ˆç„¡æ¨¡çµ„ï¼‰</button>
    <button onclick="testModuleWorker()">ğŸ”¸ æ¸¬è©¦ 2: æ¨¡çµ„ Workerï¼ˆimport config.jsï¼‰</button>
    <button onclick="testNoiseWorker()">ğŸ”º æ¸¬è©¦ 2.5: Noise Workerï¼ˆimport noise.jsï¼‰</button>
    <button onclick="testWorkerLoad()">ğŸ”¶ æ¸¬è©¦ 3: å®Œæ•´ Workerï¼ˆterrain.worker.jsï¼‰</button>
    <hr style="margin: 10px 0;">
    <button onclick="testDirectAccess()">ğŸ“„ æ¸¬è©¦ç›´æ¥è¨ªå•æª”æ¡ˆ</button>
    <button onclick="testWithTimestamp()">â° æ¸¬è©¦å¸¶æ™‚é–“æˆ³è¼‰å…¥</button>
    <button onclick="location.reload()">ğŸ”„ é‡æ–°æ•´ç†é é¢</button>

    <script>
        const results = document.getElementById('results');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function testWorkerLoad() {
            results.innerHTML = '';
            log('ğŸ§ª æ¸¬è©¦ 1ï¼šå˜—è©¦è¼‰å…¥ Workerï¼ˆç„¡å¿«å–ç ´å£ï¼‰...', 'info');

            try {
                const worker = new Worker('./js/terrain.worker.js', { type: 'module' });

                worker.onmessage = (e) => {
                    log(`âœ… Worker æˆåŠŸè¼‰å…¥ä¸¦å›æ‡‰ï¼<br><pre>${JSON.stringify(e.data, null, 2)}</pre>`, 'success');
                };

                worker.onerror = (error) => {
                    // è©³ç´°çš„éŒ¯èª¤è³‡è¨Š
                    const errorDetails = {
                        message: error.message || '(ç„¡è¨Šæ¯)',
                        filename: error.filename || '(æœªçŸ¥)',
                        lineno: error.lineno || '(æœªçŸ¥)',
                        colno: error.colno || '(æœªçŸ¥)',
                        type: error.type || '(æœªçŸ¥)',
                        error: error.error ? error.error.toString() : '(ç„¡è©³ç´°éŒ¯èª¤)'
                    };

                    log(`âŒ Worker è¼‰å…¥å¤±æ•—<br><pre>${JSON.stringify(errorDetails, null, 2)}</pre>`, 'error');
                    console.error('è©³ç´° Worker éŒ¯èª¤:', error);
                    console.error('éŒ¯èª¤ç‰©ä»¶:', errorDetails);
                };

                // æ¸¬è©¦ Worker æ˜¯å¦çœŸçš„è¢«å‰µå»º
                log(`âœ… Worker ç‰©ä»¶å·²å‰µå»ºï¼ˆä½†å¯èƒ½å°šæœªè¼‰å…¥è…³æœ¬ï¼‰`, 'info');

                setTimeout(() => {
                    log('â³ æ­£åœ¨ç­‰å¾… Worker å›æ‡‰æˆ–éŒ¯èª¤...ï¼ˆ5 ç§’è¶…æ™‚ï¼‰', 'info');
                }, 100);

                setTimeout(() => {
                    log('âš ï¸ 5 ç§’å…§æ²’æœ‰æ”¶åˆ°å›æ‡‰æˆ–éŒ¯èª¤<br>å¯èƒ½åŸå› ï¼š<br>1. Worker è¼‰å…¥ä¸­ä½†å¾ˆæ…¢<br>2. Worker å¡ä½äº†<br>3. æ²’æœ‰ç™¼é€åˆå§‹è¨Šæ¯', 'error');
                }, 5000);

            } catch (error) {
                log(`âŒ Worker å»ºæ§‹å¤±æ•—ï¼ˆå‰µå»º Worker ç‰©ä»¶æ™‚å°±å¤±æ•—äº†ï¼‰<br>éŒ¯èª¤ï¼š${error.message}<br>Stack:<br><pre>${error.stack}</pre>`, 'error');
            }
        }

        function testWithTimestamp() {
            results.innerHTML = '';
            const timestamp = Date.now();
            const url = `./js/terrain.worker.js?v=21.4&t=${timestamp}`;
            log(`ğŸ§ª æ¸¬è©¦ 2ï¼šä½¿ç”¨æ™‚é–“æˆ³è¼‰å…¥ Worker<br>URL: <code>${url}</code>`, 'info');

            try {
                const worker = new Worker(url, { type: 'module' });

                worker.onmessage = (e) => {
                    log(`âœ… Worker æˆåŠŸè¼‰å…¥ä¸¦å›æ‡‰ï¼<br><pre>${JSON.stringify(e.data, null, 2)}</pre>`, 'success');
                };

                worker.onerror = (error) => {
                    log(`âŒ Worker è¼‰å…¥å¤±æ•—<br>éŒ¯èª¤ï¼š${error.message || 'Event'}`, 'error');
                    console.error('Worker error:', error);
                };

                setTimeout(() => {
                    log('â³ æ­£åœ¨ç­‰å¾… Worker å›æ‡‰...ï¼ˆ5 ç§’è¶…æ™‚ï¼‰', 'info');
                }, 100);

                setTimeout(() => {
                    log('âš ï¸ 5 ç§’å…§æ²’æœ‰æ”¶åˆ°å›æ‡‰', 'error');
                }, 5000);

            } catch (error) {
                log(`âŒ Worker å»ºæ§‹å¤±æ•—<br>éŒ¯èª¤ï¼š${error.message}`, 'error');
            }
        }

        function testDirectAccess() {
            results.innerHTML = '';
            log('ğŸ§ª æ¸¬è©¦ 3ï¼šç›´æ¥è¨ªå•æª”æ¡ˆï¼ˆä½¿ç”¨ fetchï¼‰...', 'info');

            const urls = [
                './js/terrain.worker.js',
                `./js/terrain.worker.js?t=${Date.now()}`
            ];

            urls.forEach((url, index) => {
                fetch(url)
                    .then(response => {
                        if (response.ok) {
                            // æª¢æŸ¥ Content-Type
                            const contentType = response.headers.get('Content-Type');
                            log(`ğŸ“‹ Content-Type: <code>${contentType || '(æœªè¨­å®š)'}</code>`, 'info');

                            return response.text();
                        } else {
                            throw new Error(`HTTP ${response.status} ${response.statusText}`);
                        }
                    })
                    .then(content => {
                        const size = (content.length / 1024).toFixed(2);
                        const preview = content.substring(0, 100).replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        log(`âœ… æª”æ¡ˆå¯è¨ªå•ï¼ˆ${index === 0 ? 'ç„¡å¿«å–ç ´å£' : 'å¸¶æ™‚é–“æˆ³'}ï¼‰<br>
                             å¤§å°: ${size} KB<br>
                             é è¦½:<br><pre>${preview}...</pre>`, 'success');
                    })
                    .catch(error => {
                        log(`âŒ æª”æ¡ˆç„¡æ³•è¨ªå•ï¼ˆ${index === 0 ? 'ç„¡å¿«å–ç ´å£' : 'å¸¶æ™‚é–“æˆ³'}ï¼‰<br>
                             URL: <code>${url}</code><br>
                             éŒ¯èª¤: ${error.message}`, 'error');
                    });
            });
        }

        function testSimpleWorker() {
            results.innerHTML = '';
            log('ğŸ”¹ æ¸¬è©¦ 1ï¼šè¼‰å…¥ç°¡å–® Workerï¼ˆä¸ä½¿ç”¨ ES6 æ¨¡çµ„ï¼‰...', 'info');

            try {
                const worker = new Worker('./js/test-simple.worker.js');
                log(`âœ… Worker ç‰©ä»¶å·²å‰µå»º`, 'info');

                worker.onmessage = (e) => {
                    log(`âœ… æˆåŠŸï¼ç°¡å–® Worker å¯ä»¥è¼‰å…¥<br><pre>${JSON.stringify(e.data, null, 2)}</pre>`, 'success');
                };

                worker.onerror = (error) => {
                    log(`âŒ å¤±æ•—ï¼é€£ç°¡å–® Worker éƒ½ç„¡æ³•è¼‰å…¥<br>éŒ¯èª¤ï¼š${error.message || '(ç„¡è¨Šæ¯)'}`, 'error');
                    console.error('Simple worker error:', error);
                };

                setTimeout(() => {
                    log('âš ï¸ 5 ç§’å…§æ²’æœ‰æ”¶åˆ°å›æ‡‰', 'error');
                }, 5000);
            } catch (error) {
                log(`âŒ Worker å»ºæ§‹å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }

        function testModuleWorker() {
            results.innerHTML = '';
            log('ğŸ”¸ æ¸¬è©¦ 2ï¼šè¼‰å…¥æ¨¡çµ„ Workerï¼ˆimport config.jsï¼‰...', 'info');

            try {
                const worker = new Worker('./js/test-module.worker.js', { type: 'module' });
                log(`âœ… Worker ç‰©ä»¶å·²å‰µå»º`, 'info');

                worker.onmessage = (e) => {
                    log(`âœ… æˆåŠŸï¼æ¨¡çµ„ Worker å¯ä»¥è¼‰å…¥<br><pre>${JSON.stringify(e.data, null, 2)}</pre>`, 'success');
                };

                worker.onerror = (error) => {
                    const errorDetails = {
                        message: error.message || '(ç„¡è¨Šæ¯)',
                        filename: error.filename || '(æœªçŸ¥)',
                        lineno: error.lineno || '(æœªçŸ¥)',
                        type: error.type || '(æœªçŸ¥)'
                    };
                    log(`âŒ å¤±æ•—ï¼æ¨¡çµ„ Worker ç„¡æ³•è¼‰å…¥<br><pre>${JSON.stringify(errorDetails, null, 2)}</pre>`, 'error');
                    console.error('Module worker error:', error);
                };

                setTimeout(() => {
                    log('âš ï¸ 5 ç§’å…§æ²’æœ‰æ”¶åˆ°å›æ‡‰', 'error');
                }, 5000);
            } catch (error) {
                log(`âŒ Worker å»ºæ§‹å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }

        function testNoiseWorker() {
            results.innerHTML = '';
            log('ğŸ”º æ¸¬è©¦ 2.5ï¼šè¼‰å…¥ Noise Workerï¼ˆimport noise.jsï¼‰...', 'info');

            try {
                const worker = new Worker('./js/test-noise.worker.js', { type: 'module' });
                log(`âœ… Worker ç‰©ä»¶å·²å‰µå»º`, 'info');

                worker.onmessage = (e) => {
                    log(`âœ… æˆåŠŸï¼Noise æ¨¡çµ„å¯ä»¥è¼‰å…¥<br><pre>${JSON.stringify(e.data, null, 2)}</pre>`, 'success');
                };

                worker.onerror = (error) => {
                    const errorDetails = {
                        message: error.message || '(ç„¡è¨Šæ¯)',
                        filename: error.filename || '(æœªçŸ¥)',
                        lineno: error.lineno || '(æœªçŸ¥)',
                        type: error.type || '(æœªçŸ¥)'
                    };
                    log(`âŒ å¤±æ•—ï¼Noise æ¨¡çµ„ç„¡æ³•è¼‰å…¥<br><pre>${JSON.stringify(errorDetails, null, 2)}</pre>`, 'error');
                    console.error('Noise worker error:', error);
                };

                setTimeout(() => {
                    log('âš ï¸ 5 ç§’å…§æ²’æœ‰æ”¶åˆ°å›æ‡‰', 'error');
                }, 5000);
            } catch (error) {
                log(`âŒ Worker å»ºæ§‹å¤±æ•—ï¼š${error.message}`, 'error');
            }
        }

        // è‡ªå‹•åŸ·è¡Œæ¸¬è©¦
        window.addEventListener('load', () => {
            log('ğŸ“‹ é é¢å·²è¼‰å…¥ï¼Œæº–å‚™é€²è¡Œè¨ºæ–·', 'info');
            log('ğŸ’¡ è«‹ä¾åºé»æ“Šæ¸¬è©¦æŒ‰éˆ•ï¼š', 'info');
            log('   1ï¸âƒ£ æ¸¬è©¦ç°¡å–® Workerï¼ˆç¢ºèªåŸºæœ¬åŠŸèƒ½ï¼‰', 'info');
            log('   2ï¸âƒ£ æ¸¬è©¦æ¨¡çµ„ Workerï¼ˆç¢ºèª ES6 æ¨¡çµ„æ”¯æ´ï¼‰', 'info');
            log('   3ï¸âƒ£ æ¸¬è©¦å®Œæ•´ Workerï¼ˆè¨ºæ–·å¯¦éš›å•é¡Œï¼‰', 'info');
        });
    </script>
</body>
</html>
